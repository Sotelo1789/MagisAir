{% extends 'base.html' %}

{% block content %}
  <div class="page-header">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <div>
      <p class="eyebrow">Customer Care</p>
      <h1 class="page-title">Passenger Directory</h1>
      <p class="page-subtitle">Search, segment, and review individual travel histories.</p>
    </div>
    <div class="table-buttons">
      <a href="{% url 'airline:passenger_create' %}" class="btn btn-primary">Add Passenger</a>
    </div>
  </div>

  <form method="get" class="card">
    <div class="card__body form-grid">
      <div class="form-group">
        <label for="search">Search</label>
        <input
          id="search"
          name="search"
          value="{{ filters.search }}"
          placeholder="Search by name or passenger ID..."
        />
      </div>
      <div class="form-group">
        <label for="gender">Gender</label>
        <select id="gender" name="gender">
          <option value="">All</option>
          <option value="M" {% if filters.gender == 'M' %}selected{% endif %}>Male</option>
          <option value="F" {% if filters.gender == 'F' %}selected{% endif %}>Female</option>
          <option value="O" {% if filters.gender == 'O' %}selected{% endif %}>Other</option>
        </select>
      </div>
      <div class="form-group flex-[0_0_auto]! self-end flex gap-3">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
        <a href="{% url 'airline:passenger_list' %}" class="btn btn-outline">Clear</a>
      </div>
    </div>
  </form>

  <div class="stat-grid">
    <div class="stat-card">
      <div class="stat-label">Passengers in system</div>
      <div class="stat-value">{{ summary.total }}</div>
      <p class="card__meta">All active profiles</p>
    </div>
    <div class="stat-card">
      <div class="stat-label">Visible passengers</div>
      <div class="stat-value">{{ summary.filtered }}</div>
      <p class="card__meta">Matching current filter</p>
    </div>
  </div>

  <div class="passenger-layout">
    <div>
      <div class="card">
        <div class="card__body">
          <h2 class="card__title">Passenger List</h2>
          <p class="card__meta">Select a record to view full history.</p>

          <div class="space-y-3">
            {% for passenger in passengers %}
              <a
                class="passenger-card {% if selected_passenger and passenger.passenger_id == selected_passenger.passenger_id %}active{% endif %}"
                href="?selected={{ passenger.passenger_id }}{% if filters.search %}&search={{ filters.search|urlencode }}{% endif %}{% if filters.gender %}&gender={{ filters.gender }}{% endif %}"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <div class="font-semibold">{{ passenger.last_name }}, {{ passenger.first_name }}</div>
                    <div class="text-small text-muted">{{ passenger.birthdate|date:"M d, Y" }}</div>
                  </div>
                  <span class="badge">{{ passenger.passenger_id }}</span>
                </div>
                <div class="text-small text-muted mt-2">
                  {{ passenger.get_gender_display }}
                </div>
              </a>
            {% empty %}
              <div class="empty-state">No passengers match the current filter.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="card__body">
          {% if selected_passenger %}
            <h2 class="card__title">Passenger Summary</h2>
            <p class="card__meta">Profile overview and recent bookings.</p>

            <div class="stat-card mb-6">
              <div class="flex justify-between items-center">
                <div>
                  <div class="stat-label">Name</div>
                  <div class="text-[22px]! stat-value">
                    {{ selected_passenger.first_name }} {{ selected_passenger.last_name }}
                  </div>
                </div>
                <span class="badge">{{ selected_passenger.passenger_id }}</span>
              </div>
              <div class="mt-4 text-[13px] text-(--text-muted) grid gap-6">
                <div>Birthdate: {{ selected_passenger.birthdate|date:"M d, Y" }}</div>
                <div>Gender: {{ selected_passenger.get_gender_display }}</div>
              </div>
            </div>

            <h3 class="card__title text-[16px]!">Booking History</h3>
            {% if booking_history %}
              {% for booking in booking_history %}
                <div class="booking-card">
                  <div class="booking-card__header">
                    <div>
                      <div class="text-small">Booking Reference</div>
                      <div class="text-mono">{{ booking.booking_reference }}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-small">Total</div>
                      <div class="text-mono">Php {{ booking.total|floatformat:2 }}</div>
                    </div>
                  </div>
                  <div class="booking-card__body">
                    <div class="text-small text-muted mb-2.5">
                      Booked on {{ booking.date|date:"M d, Y" }}
                    </div>
                    <div class="timeline">
                      {% for leg in booking.itinerary %}
                        <div class="timeline__item">
                          <div class="font-[600px]">
                            {{ leg.origin }} → {{ leg.destination }}
                          </div>
                          <div class="text-small text-muted">
                            {% if leg.flight_no_formatted %}{{ leg.flight_no_formatted }}{% else %}Flight {{ leg.flight_no }}{% endif %} • {% if leg.date %}{{ leg.date|date:"M d, Y" }}{% else %}—{% endif %} •
                            {% if leg.departure %}{{ leg.departure|time:"H:i" }}{% else %}—{% endif %}
                            -
                            {% if leg.arrival %}{{ leg.arrival|time:"H:i" }}{% else %}—{% endif %}
                          </div>
                        </div>
                      {% empty %}
                        <div class="text-small text-muted">No itinerary items recorded.</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">
                No bookings linked to this passenger yet.
              </div>
            {% endif %}
          {% else %}
            <div class="empty-state">
              Select a passenger to view profile details.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}